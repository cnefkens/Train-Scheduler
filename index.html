<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>Train SchedulerEmployee Data Management</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
  <link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
  
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  
  <!--jquery link -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  
  <!-- <script type="text/javascript" async src="https://www.tenor.co/embed.js"></script> -->
  
  <!-- firebase link -->
  <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>
  
  <!--moment.js link -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>

</head>

<body>
  <div class="container">
  <!-- Header -->
    <div class="row">
      <div class="col-md-12">      
          <div class="jumbotron" id="pageTitle">
            <h1>All Aboard the Party Train</h1>
            <h3>A Comprehensive Listing of Train Schedules</h3>
          </div>
      </div>
    </div>
    <!-- Search Form -->
    <div class="row" id="trainsRow">
      <div class="col-md-12" id="employeeCol"> 
        <div class="panel panel-default" id="trainPanel">          
                
          <div class="panel-heading" id="trainPanelHeader">Current trains</div>
            
            
          <div class="panel-body">
          `<table class="table" id="employeeTable">
             <thead>
                <tr>
              <th>Train Name</th>
              <th>Destination</th>
              <th>Frequency (min)</th>
              <th>Next Arrival</th>
              <th>Minutes Away</th>
              </tr>
          </thead>
  <tbody >
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>
  
          </div>            
        </div>
      </div> 
    
    </div>

    <!-- Result Form -->
    <div class="row">
      <div class="col-md-12">
        <div class="panel panel-default" id="addPanel">   
          <div class="panel-heading" id="addPanelHeader">Add Train</div>

          <div class="panel-body" id="addPanelBody">
            <form id="addForm">
              <div class="form-group">
                  <label for="TrainName">Train Name</label>                
                  <input type="text" class="form-control" id="trainName">
              </div>
              <div class="form-group">
                <label for="Destination">Destination</label>                
                <input type="text" class="form-control" id="destination">
              </div>
              <div class="form-group">
                  <label for="startTime">Train Start Time (HH:mm - military time)</label>                
                  <input type="text" class="form-control" id="startTime">
              </div>
              <div class="form-group">
                <label for="Frequency">Frequency</label>                
                <input type="text" class="form-control" id="frequency">
              </div>
              <button type="submit" class="btn btn-default" id="submitButton">Submit</button>
          </form>

<!-- role="search" ??????             -->
          </div>  
        </div>      
      </div>
    </div>
  </div>
  
  <style>
/*@font-face{ 
  font-family: 'Railway';
  src: url('fonts/Railway-webfont.woff') format('woff');      
      }*/

body {
  font-family: 'Helvetica';
}
  #pageTitle {
    background: darkslategrey;
    color: white;
  }
    h1 {
      text-align: center;
      /*font-family: "Times New Roman";*/
      font-size: 52;
    }
    
    h3 {
      text-align: center;
    }

    #addPanelHeader, #trainPanelHeader {
      background: dodgerblue;
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    
  </style>

<!-- <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script> -->


<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDjLBsdmmBXfwyHWVoRwxHAII96CgnTWSg",
    authDomain: "traintime-73300.firebaseapp.com",
    databaseURL: "https://traintime-73300.firebaseio.com",
    projectId: "traintime-73300",
    storageBucket: "traintime-73300.appspot.com",
    messagingSenderId: "626523616192"
  };
  firebase.initializeApp(config);

  var database = firebase.database();


  //database.ref().clear();
  database.ref().on("child_added", function(childSnapshot) {
 var mmt = moment();

// Your moment at midnight
var mmtMidnight = mmt.clone().startOf('day');

// Difference in minutes
var currMinutes = parseInt(mmt.diff(mmtMidnight, 'minutes'));
var startMinutes= parseInt(moment.duration(childSnapshot.val().startTime,'hh:mm').as('minutes'));
var minutesLapsed=currMinutes-startMinutes;
var frequency=childSnapshot.val().frequency;
var minutesAway =frequency - minutesLapsed%frequency;
  //var todayInMonths = d.getFullYear()*12 + d.getMonth() + 1;
  //var startDateArr = $("#startDate").val().split("/");
  //var startDateInMonths = startDateArr[0] * 12 + startDateArr[1];
  console.log("Train name:" + childSnapshot.val().trainName);
  console.log("Destination: " + childSnapshot.val().destination);
  console.log("Frequency:" + childSnapshot.val().frequency);
  console.log("Start time: " + childSnapshot.val().startTime);
  console.log("Start minutes:" + moment.duration(childSnapshot.val().startTime,'hh:mm').as('minutes'));
  console.log("Current time:" + moment().format('hh:mm'));
  console.log("Current minutes:" + currMinutes);
  console.log("Minutes lapsed: " + minutesLapsed);
  console.log("Modulo: " + minutesLapsed%frequency);
 
 
  console.log("Minutes away: " + minutesAway);
  var nextArrival = moment().add(minutesAway,'minutes').format("HH:mm");
  console.log(moment().format('HH:mm'));
  console.log("Next arrival:" + nextArrival);
      // Log everything that's coming out of snapshot

    

      $("#employeeTable").append("<tr><td>" + childSnapshot.val().trainName 
        + "<td>" + childSnapshot.val().destination + "</td>"
        + "<td>" + childSnapshot.val().frequency + "</td>"
        + "<td>" + nextArrival + "</td>"
        + "<td>" + minutesAway + "</td>"
        + " </tr>");

    // Handle the errors
    }, function(errorObject) {
      console.log("Errors handled: " + errorObject.code);
    });

$("#submitButton").on("click", function(event) {
  event.preventDefault();

  database.ref().push({
    trainName: $("#trainName").val().trim(),
    destination: $("#destination").val().trim(),
    startTime: $("#startTime").val(),
    frequency: parseInt($("#frequency").val())
  });
});


  
  
  </script>
  </body>
  </html>
